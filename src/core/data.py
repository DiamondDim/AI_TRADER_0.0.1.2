import MetaTrader5 as mt5
import pandas as pd
import numpy as np
import logging
from datetime import datetime, timedelta
from typing import Optional, Dict, List, Union

logger = logging.getLogger('DataFetcher')


class DataFetcher:
    def __init__(self, mt5_connection):
        self.mt5 = mt5_connection
        self.logger = logger

        # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
        self.timeframes = {
            'M1': mt5.TIMEFRAME_M1,
            'M5': mt5.TIMEFRAME_M5,
            'M15': mt5.TIMEFRAME_M15,
            'M30': mt5.TIMEFRAME_M30,
            'H1': mt5.TIMEFRAME_H1,
            'H4': mt5.TIMEFRAME_H4,
            'D1': mt5.TIMEFRAME_D1,
            'W1': mt5.TIMEFRAME_W1,
            'MN1': mt5.TIMEFRAME_MN1
        }

    def get_all_symbols(self) -> List[str]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
        try:
            symbols = mt5.symbols_get()
            if symbols:
                return [symbol.name for symbol in symbols]
            return []
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤: {e}")
            return []

    def get_symbol_info(self, symbol: str) -> Optional[any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–º–≤–æ–ª–µ"""
        try:
            return mt5.symbol_info(symbol)
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–º–≤–æ–ª–µ {symbol}: {e}")
            return None

    def get_symbols(self, filter_symbol: str = "") -> List[str]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
        try:
            symbols = mt5.symbols_get()
            if not symbols:
                self.logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–∏–º–≤–æ–ª–æ–≤")
                return []

            symbol_names = [s.name for s in symbols]

            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ñ–∏–ª—å—Ç—Ä
            if filter_symbol:
                symbol_names = [s for s in symbol_names if filter_symbol.upper() in s.upper()]

            self.logger.info(f"üìã –ü–æ–ª—É—á–µ–Ω–æ {len(symbol_names)} —Å–∏–º–≤–æ–ª–æ–≤")
            return symbol_names

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤: {str(e)}")
            return []

    def get_symbol_info_full(self, symbol: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–º–≤–æ–ª–µ"""
        try:
            info = mt5.symbol_info(symbol)
            if not info:
                self.logger.error(f"–°–∏–º–≤–æ–ª {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return None

            return {
                'name': info.name,
                'description': info.description,
                'currency_base': info.currency_base,
                'currency_profit': info.currency_profit,
                'currency_margin': info.currency_margin,
                'digits': info.digits,
                'trade_mode': info.trade_mode,
                'trade_exemode': info.trade_exemode,
                'swap_mode': info.swap_mode,
                'volume_min': info.volume_min,
                'volume_max': info.volume_max,
                'volume_step': info.volume_step,
                'spread': info.spread,
                'spread_float': info.spread_float
            }
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–º–≤–æ–ª–µ: {str(e)}")
            return None

    def prepare_symbol(self, symbol: str) -> bool:
        """–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–∏–º–≤–æ–ª
            symbol_info = mt5.symbol_info(symbol)
            if symbol_info is None:
                self.logger.error(f"–°–∏–º–≤–æ–ª {symbol} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return False

            # –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω –≤ Market Watch, –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
            if not symbol_info.visible:
                self.logger.info(f"üîç –í—ã–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª {symbol} –≤ Market Watch")
                if not mt5.symbol_select(symbol, True):
                    self.logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Å–∏–º–≤–æ–ª {symbol}")
                    return False

            return True

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Å–∏–º–≤–æ–ª–∞ {symbol}: {str(e)}")
            return False

    def find_correct_symbol(self, base_symbol: str) -> Optional[str]:
        """
        –ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —Å–∏–º–≤–æ–ª–∞ —Å —É—á–µ—Ç–æ–º —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤ –±—Ä–æ–∫–µ—Ä–∞
        """
        possible_suffixes = ['', 'rfd', 'm', 'f', 'q', 'a', 'b', 'c', 'd', 'e']

        for suffix in possible_suffixes:
            test_symbol = base_symbol + suffix
            if self._check_symbol_exists(test_symbol):
                return test_symbol

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ —Å–∏–º–≤–æ–ª—ã
        all_symbols = self.get_all_symbols()
        if all_symbols:
            for symbol in all_symbols:
                if base_symbol in symbol:
                    self.logger.info(f"üîç –ù–∞–π–¥–µ–Ω –ø–æ—Ö–æ–∂–∏–π —Å–∏–º–≤–æ–ª: {symbol} –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ {base_symbol}")
                    if self._check_symbol_exists(symbol):
                        return symbol

        return None

    def _check_symbol_exists(self, symbol: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–∏–º–≤–æ–ª–∞"""
        try:
            # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–º–≤–æ–ª–µ
            symbol_info = self.get_symbol_info(symbol)
            if symbol_info:
                # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                price = self.get_current_price(symbol)
                return price is not None and price.get('bid', 0) > 0
            return False
        except Exception as e:
            self.logger.debug(f"–°–∏–º–≤–æ–ª {symbol} –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
            return False

    def get_rates(self, symbol: str, timeframe: str, count: int = 1000,
                  start_date: Optional[datetime] = None,
                  end_date: Optional[datetime] = None) -> Optional[pd.DataFrame]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ

        Args:
            symbol: —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–º–≤–æ–ª
            timeframe: —Ç–∞–π–º—Ñ—Ä–µ–π–º ('M1', 'H1', 'D1' –∏ —Ç.–¥.)
            count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ä–æ–≤
            start_date: –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
            end_date: –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞

        Returns:
            DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        """
        try:
            if not self.mt5.check_connection():
                self.logger.error("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å MT5")
                return None

            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º
            tf = self.timeframes.get(timeframe.upper())
            if tf is None:
                self.logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º: {timeframe}")
                return None

            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–º–≤–æ–ª
            if not self.prepare_symbol(symbol):
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª
                correct_symbol = self.find_correct_symbol(symbol)
                if correct_symbol:
                    self.logger.info(f"üîÑ –ê–≤—Ç–æ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞: {symbol} -> {correct_symbol}")
                    symbol = correct_symbol
                    if not self.prepare_symbol(symbol):
                        return None
                else:
                    return None

            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            if start_date and end_date:
                rates = mt5.copy_rates_range(symbol, tf, start_date, end_date)
            elif start_date:
                rates = mt5.copy_rates_from(symbol, tf, start_date, count)
            else:
                rates = mt5.copy_rates_from_pos(symbol, tf, 0, count)

            if rates is None:
                error_code = mt5.last_error()
                self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {symbol}: {error_code}")
                return None

            if len(rates) == 0:
                self.logger.warning(f"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {symbol} {timeframe}")
                return None

            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DataFrame
            df = pd.DataFrame(rates)
            df['time'] = pd.to_datetime(df['time'], unit='s')
            df.set_index('time', inplace=True)

            # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            df.columns = ['open', 'high', 'low', 'close', 'tick_volume', 'spread', 'real_volume']

            # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏
            df['price_change'] = df['close'].pct_change()
            df['price_change_abs'] = df['close'].diff()
            df['range'] = df['high'] - df['low']
            df['typical_price'] = (df['high'] + df['low'] + df['close']) / 3

            self.logger.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(df)} –±–∞—Ä–æ–≤ –¥–ª—è {symbol} {timeframe}")
            return df

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –≤ get_rates –¥–ª—è {symbol}: {str(e)}")
            return None

    def get_current_price(self, symbol: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å–∏–º–≤–æ–ª–∞"""
        try:
            if not self.prepare_symbol(symbol):
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª
                correct_symbol = self.find_correct_symbol(symbol)
                if correct_symbol:
                    self.logger.info(f"üîÑ –ê–≤—Ç–æ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞: {symbol} -> {correct_symbol}")
                    symbol = correct_symbol
                    if not self.prepare_symbol(symbol):
                        return None
                else:
                    return None

            tick = mt5.symbol_info_tick(symbol)
            if tick is None:
                self.logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–∏–∫ –¥–ª—è {symbol}")
                return None

            return {
                'bid': tick.bid,
                'ask': tick.ask,
                'last': tick.last,
                'volume': tick.volume,
                'time': pd.to_datetime(tick.time, unit='s'),
                'flags': tick.flags
            }
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –¥–ª—è {symbol}: {str(e)}")
            return None

    def calculate_technical_indicators(self, df: pd.DataFrame, trading_style: str = 'positional') -> pd.DataFrame:
        """
        –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏

        Args:
            df: DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏
            trading_style: —Å—Ç–∏–ª—å —Ç–æ—Ä–≥–æ–≤–ª–∏ ('positional', 'swing', 'scalping')

        Returns:
            DataFrame —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
        """
        try:
            self.logger.info(f"üéØ –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —Å—Ç–∏–ª—è: {trading_style}")

            if trading_style == 'positional':
                return self._calculate_positional_indicators(df)
            elif trading_style == 'swing':
                return self._calculate_swing_indicators(df)
            elif trading_style == 'scalping':
                return self._calculate_scalping_indicators(df)
            else:
                self.logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∏–ª—å —Ç–æ—Ä–≥–æ–≤–ª–∏: {trading_style}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–∞–∑–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã.")
                return self._calculate_basic_indicators(df)

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: {str(e)}")
            return df

    def _calculate_basic_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """–ë–∞–∑–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∏–ª–µ–π"""
        try:
            # –°–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ (–±–∞–∑–æ–≤—ã–µ)
            df['sma_20'] = df['close'].rolling(window=20).mean()
            df['sma_50'] = df['close'].rolling(window=50).mean()

            # RSI
            delta = df['close'].diff()
            gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
            rs = gain / loss
            df['rsi'] = 100 - (100 / (1 + rs))

            # ATR (Average True Range)
            high_low = df['high'] - df['low']
            high_close = np.abs(df['high'] - df['close'].shift())
            low_close = np.abs(df['low'] - df['close'].shift())
            true_range = np.maximum(np.maximum(high_low, high_close), low_close)
            df['atr'] = true_range.rolling(window=14).mean()

            # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
            df['volatility'] = df['range'].rolling(window=20).mean()

            return df

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–∑–æ–≤—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: {str(e)}")
            return df

    def _calculate_positional_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π)"""
        try:
            # –ë–∞–∑–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            df = self._calculate_basic_indicators(df)

            # –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Å–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ
            df['sma_100'] = df['close'].rolling(window=100).mean()
            df['sma_200'] = df['close'].rolling(window=200).mean()
            df['ema_50'] = df['close'].ewm(span=50).mean()
            df['ema_100'] = df['close'].ewm(span=100).mean()

            # MACD –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
            df['ema_12'] = df['close'].ewm(span=12).mean()
            df['ema_26'] = df['close'].ewm(span=26).mean()
            df['macd'] = df['ema_12'] - df['ema_26']
            df['macd_signal'] = df['macd'].ewm(span=9).mean()
            df['macd_histogram'] = df['macd'] - df['macd_signal']

            # Bollinger Bands –¥–ª—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
            df['bb_middle'] = df['close'].rolling(window=20).mean()
            bb_std = df['close'].rolling(window=20).std()
            df['bb_upper'] = df['bb_middle'] + (bb_std * 2)
            df['bb_lower'] = df['bb_middle'] - (bb_std * 2)
            df['bb_width'] = df['bb_upper'] - df['bb_lower']
            df['bb_position'] = (df['close'] - df['bb_lower']) / (df['bb_upper'] - df['bb_lower'])

            # Parabolic SAR –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
            df['psar'] = self._calculate_psar(df)

            # ADX –¥–ª—è —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞
            df['adx'] = self._calculate_adx(df)

            # Volume-based indicators
            df['volume_sma'] = df['tick_volume'].rolling(window=20).mean()
            df['volume_ratio'] = df['tick_volume'] / df['volume_sma']

            self.logger.debug("‚úÖ –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã")
            return df

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: {str(e)}")
            return df

    def _calculate_swing_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è —Å–≤–∏–Ω–≥-—Ç—Ä–µ–π–¥–∏–Ω–≥–∞ (—Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ–π)"""
        try:
            # –ë–∞–∑–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            df = self._calculate_basic_indicators(df)

            # –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —Å–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ
            df['sma_20'] = df['close'].rolling(window=20).mean()
            df['sma_50'] = df['close'].rolling(window=50).mean()
            df['ema_21'] = df['close'].ewm(span=21).mean()
            df['ema_34'] = df['close'].ewm(span=34).mean()
            df['ema_55'] = df['close'].ewm(span=55).mean()

            # MACD
            df['ema_12'] = df['close'].ewm(span=12).mean()
            df['ema_26'] = df['close'].ewm(span=26).mean()
            df['macd'] = df['ema_12'] - df['ema_26']
            df['macd_signal'] = df['macd'].ewm(span=9).mean()
            df['macd_histogram'] = df['macd'] - df['macd_signal']

            # Stochastic Oscillator
            df['stoch_k'], df['stoch_d'] = self._calculate_stochastic(df)

            # Williams %R
            df['williams_r'] = self._calculate_williams_r(df)

            # CCI (Commodity Channel Index)
            df['cci'] = self._calculate_cci(df)

            # Bollinger Bands
            df['bb_middle'] = df['close'].rolling(window=20).mean()
            bb_std = df['close'].rolling(window=20).std()
            df['bb_upper'] = df['bb_middle'] + (bb_std * 2)
            df['bb_lower'] = df['bb_middle'] - (bb_std * 2)

            # Momentum
            df['momentum'] = df['close'] - df['close'].shift(10)

            # Rate of Change
            df['roc'] = ((df['close'] - df['close'].shift(10)) / df['close'].shift(10)) * 100

            self.logger.debug("‚úÖ –°–≤–∏–Ω–≥-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã")
            return df

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–≤–∏–Ω–≥-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: {str(e)}")
            return df

    def _calculate_scalping_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞ (–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π)"""
        try:
            # –ë–∞–∑–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            df = self._calculate_basic_indicators(df)

            # –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —Å–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ
            df['sma_5'] = df['close'].rolling(window=5).mean()
            df['sma_10'] = df['close'].rolling(window=10).mean()
            df['sma_20'] = df['close'].rolling(window=20).mean()
            df['ema_8'] = df['close'].ewm(span=8).mean()
            df['ema_13'] = df['close'].ewm(span=13).mean()
            df['ema_21'] = df['close'].ewm(span=21).mean()

            # Bollinger Bands –¥–ª—è —Å–∫–∞–ª—å–ø–∏–Ω–≥–∞
            df['bb_middle'] = df['close'].rolling(window=20).mean()
            bb_std = df['close'].rolling(window=20).std()
            df['bb_upper'] = df['bb_middle'] + (bb_std * 2)
            df['bb_lower'] = df['bb_middle'] - (bb_std * 2)
            df['bb_squeeze'] = (df['bb_upper'] - df['bb_lower']) / df['bb_middle']

            # Stochastic RSI
            df['stoch_rsi'] = self._calculate_stoch_rsi(df)

            # VWAP (Volume Weighted Average Price)
            df['vwap'] = (df['typical_price'] * df['tick_volume']).cumsum() / df['tick_volume'].cumsum()

            # Momentum indicators
            df['momentum_5'] = df['close'] - df['close'].shift(5)
            df['momentum_10'] = df['close'] - df['close'].shift(10)

            # Price acceleration
            df['acceleration'] = df['momentum_5'] - df['momentum_5'].shift(1)

            # Ichimoku Cloud (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
            df = self._calculate_ichimoku(df)

            # Volume-based indicators
            df['volume_ema'] = df['tick_volume'].ewm(span=20).mean()
            df['volume_ratio'] = df['tick_volume'] / df['volume_ema']

            # Spread analysis
            df['spread_ratio'] = df['spread'] / df['atr']

            self.logger.debug("‚úÖ –°–∫–∞–ª—å–ø–∏–Ω–≥-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã")
            return df

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∞–ª—å–ø–∏–Ω–≥-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: {str(e)}")
            return df

    def _calculate_psar(self, df: pd.DataFrame, af_start: float = 0.02, af_increment: float = 0.02,
                        af_max: float = 0.2) -> pd.Series:
        """–†–∞—Å—á–µ—Ç Parabolic SAR"""
        try:
            high = df['high'].values
            low = df['low'].values
            close = df['close'].values

            psar = np.zeros(len(df))
            trend = np.zeros(len(df))
            af = af_start
            ep = low[0] if close[0] > close[1] else high[0]
            sar = high[0] if close[0] > close[1] else low[0]

            for i in range(2, len(df)):
                reverse = False

                if trend[i - 1] == 1:  # uptrend
                    sar = sar + af * (ep - sar)
                    if low[i] < sar:
                        trend[i] = -1
                        sar = ep
                        af = af_start
                        ep = low[i]
                        reverse = True
                    else:
                        trend[i] = 1
                        if high[i] > ep:
                            ep = high[i]
                            af = min(af + af_increment, af_max)
                else:  # downtrend
                    sar = sar - af * (sar - ep)
                    if high[i] > sar:
                        trend[i] = 1
                        sar = ep
                        af = af_start
                        ep = high[i]
                        reverse = True
                    else:
                        trend[i] = -1
                        if low[i] < ep:
                            ep = low[i]
                            af = min(af + af_increment, af_max)

                if not reverse:
                    if trend[i] == 1:
                        sar = min(sar, low[i - 1], low[i - 2])
                    else:
                        sar = max(sar, high[i - 1], high[i - 2])

                psar[i] = sar

            return pd.Series(psar, index=df.index)

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ PSAR: {str(e)}")
            return pd.Series(np.nan, index=df.index)

    def _calculate_adx(self, df: pd.DataFrame, period: int = 14) -> pd.Series:
        """–†–∞—Å—á–µ—Ç ADX (Average Directional Index)"""
        try:
            high = df['high']
            low = df['low']
            close = df['close']

            # Calculate +DM and -DM
            up_move = high - high.shift(1)
            down_move = low.shift(1) - low

            plus_dm = np.where((up_move > down_move) & (up_move > 0), up_move, 0)
            minus_dm = np.where((down_move > up_move) & (down_move > 0), down_move, 0)

            # Calculate True Range
            tr1 = high - low
            tr2 = abs(high - close.shift(1))
            tr3 = abs(low - close.shift(1))
            tr = np.maximum(np.maximum(tr1, tr2), tr3)

            # Smooth the values
            plus_di = 100 * (pd.Series(plus_dm).rolling(window=period).mean() /
                             pd.Series(tr).rolling(window=period).mean())
            minus_di = 100 * (pd.Series(minus_dm).rolling(window=period).mean() /
                              pd.Series(tr).rolling(window=period).mean())

            # Calculate DX and ADX
            dx = 100 * abs(plus_di - minus_di) / (plus_di + minus_di)
            adx = dx.rolling(window=period).mean()

            return adx

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ ADX: {str(e)}")
            return pd.Series(np.nan, index=df.index)

    def _calculate_stochastic(self, df: pd.DataFrame, k_period: int = 14, d_period: int = 3) -> tuple:
        """–†–∞—Å—á–µ—Ç Stochastic Oscillator"""
        try:
            low_min = df['low'].rolling(window=k_period).min()
            high_max = df['high'].rolling(window=k_period).max()

            stoch_k = 100 * ((df['close'] - low_min) / (high_max - low_min))
            stoch_d = stoch_k.rolling(window=d_period).mean()

            return stoch_k, stoch_d

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ Stochastic: {str(e)}")
            return pd.Series(np.nan, index=df.index), pd.Series(np.nan, index=df.index)

    def _calculate_williams_r(self, df: pd.DataFrame, period: int = 14) -> pd.Series:
        """–†–∞—Å—á–µ—Ç Williams %R"""
        try:
            highest_high = df['high'].rolling(window=period).max()
            lowest_low = df['low'].rolling(window=period).min()

            williams_r = -100 * ((highest_high - df['close']) / (highest_high - lowest_low))
            return williams_r

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ Williams %R: {str(e)}")
            return pd.Series(np.nan, index=df.index)

    def _calculate_cci(self, df: pd.DataFrame, period: int = 20) -> pd.Series:
        """–†–∞—Å—á–µ—Ç CCI (Commodity Channel Index)"""
        try:
            typical_price = (df['high'] + df['low'] + df['close']) / 3
            sma = typical_price.rolling(window=period).mean()
            mad = typical_price.rolling(window=period).apply(
                lambda x: np.abs(x - x.mean()).mean(), raw=False
            )

            cci = (typical_price - sma) / (0.015 * mad)
            return cci

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ CCI: {str(e)}")
            return pd.Series(np.nan, index=df.index)

    def _calculate_stoch_rsi(self, df: pd.DataFrame, rsi_period: int = 14, stoch_period: int = 14) -> pd.Series:
        """–†–∞—Å—á–µ—Ç Stochastic RSI"""
        try:
            # Calculate RSI first
            delta = df['close'].diff()
            gain = (delta.where(delta > 0, 0)).rolling(window=rsi_period).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(window=rsi_period).mean()
            rs = gain / loss
            rsi = 100 - (100 / (1 + rs))

            # Calculate Stochastic RSI
            rsi_min = rsi.rolling(window=stoch_period).min()
            rsi_max = rsi.rolling(window=stoch_period).max()

            stoch_rsi = (rsi - rsi_min) / (rsi_max - rsi_min)
            return stoch_rsi

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ Stochastic RSI: {str(e)}")
            return pd.Series(np.nan, index=df.index)

    def _calculate_ichimoku(self, df: pd.DataFrame) -> pd.DataFrame:
        """–†–∞—Å—á–µ—Ç —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ Ichimoku Cloud"""
        try:
            # Tenkan-sen (Conversion Line)
            nine_period_high = df['high'].rolling(window=9).max()
            nine_period_low = df['low'].rolling(window=9).min()
            df['tenkan_sen'] = (nine_period_high + nine_period_low) / 2

            # Kijun-sen (Base Line)
            twenty_six_period_high = df['high'].rolling(window=26).max()
            twenty_six_period_low = df['low'].rolling(window=26).min()
            df['kijun_sen'] = (twenty_six_period_high + twenty_six_period_low) / 2

            # Senkou Span A (Leading Span A)
            df['senkou_span_a'] = ((df['tenkan_sen'] + df['kijun_sen']) / 2).shift(26)

            # Simple cloud signals
            df['ichimoku_signal'] = np.where(
                df['close'] > df['senkou_span_a'], 1,
                np.where(df['close'] < df['senkou_span_a'], -1, 0)
            )

            return df

        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ Ichimoku: {str(e)}")
            return df
